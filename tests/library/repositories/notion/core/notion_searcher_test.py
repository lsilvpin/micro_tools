import sys, os

from main.library.repositories.notion.core.notion_searcher import NotionSearcher
from main.library.tools.core.log_tool import LogTool
from main.library.tools.core.settings_tool import SettingsTool

sys.path.insert(0, os.path.abspath("."))

from main.library.di_container import Container

container: Container = Container()
settings_tool: SettingsTool = container.settings_tool()
log_tool: LogTool = container.log_tool()
notion_searcher: NotionSearcher = container.notion_searcher()


def test_should_search_elements(mocker):
    # Mocks
    successResponse = mocker.Mock()
    successResponse.status = 200
    sample: str = (
        '{"object":"list","results":[{"object":"page","id":"0c3eea8c-661c-4f12-8bee-b3a376368d1a","created_time":"2023-08-31T21:31:00.000Z","last_edited_time":"2023-08-31T21:31:00.000Z","created_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"last_edited_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"cover":null,"icon":{"type":"emoji","emoji":"ðŸ§ "},"parent":{"type":"page_id","page_id":"d2623db9-028f-4429-998b-fe9357923c0c"},"archived":false,"in_trash":false,"properties":{"title":{"id":"title","type":"title","title":[{"type":"text","text":{"content":"OrganizaÃ§Ãµes","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"OrganizaÃ§Ãµes","href":null}]}},"url":"https://www.notion.so/Organiza-es-0c3eea8c661c4f128beeb3a376368d1a","public_url":null},{"object":"page","id":"6d88d02c-0437-47d0-8aff-2c9341d11559","created_time":"2023-08-31T21:31:00.000Z","last_edited_time":"2023-08-31T21:31:00.000Z","created_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"last_edited_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"cover":null,"icon":{"type":"emoji","emoji":"âœ‰ï¸"},"parent":{"type":"page_id","page_id":"d2623db9-028f-4429-998b-fe9357923c0c"},"archived":false,"in_trash":false,"properties":{"title":{"id":"title","type":"title","title":[{"type":"text","text":{"content":"Convite","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"Convite","href":null}]}},"url":"https://www.notion.so/Convite-6d88d02c043747d08aff2c9341d11559","public_url":null},{"object":"page","id":"708f4db7-2f17-4bb7-975c-a55cdaef6821","created_time":"2023-08-31T21:31:00.000Z","last_edited_time":"2023-08-31T21:31:00.000Z","created_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"last_edited_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"cover":null,"icon":{"type":"emoji","emoji":"ðŸ•µï¸"},"parent":{"type":"page_id","page_id":"d2623db9-028f-4429-998b-fe9357923c0c"},"archived":false,"in_trash":false,"properties":{"title":{"id":"title","type":"title","title":[{"type":"text","text":{"content":"NPCs","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"NPCs","href":null}]}},"url":"https://www.notion.so/NPCs-708f4db72f174bb7975ca55cdaef6821","public_url":null},{"object":"page","id":"84e4e381-f4c5-4beb-b8ab-c91618c75e95","created_time":"2023-08-31T21:31:00.000Z","last_edited_time":"2023-08-31T21:31:00.000Z","created_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"last_edited_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"cover":null,"icon":{"type":"emoji","emoji":"ðŸŽ®"},"parent":{"type":"page_id","page_id":"d2623db9-028f-4429-998b-fe9357923c0c"},"archived":false,"in_trash":false,"properties":{"title":{"id":"title","type":"title","title":[{"type":"text","text":{"content":"Sistema","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"Sistema","href":null}]}},"url":"https://www.notion.so/Sistema-84e4e381f4c54bebb8abc91618c75e95","public_url":null},{"object":"page","id":"e775fc47-d30f-46f7-9182-af8c70b286f3","created_time":"2023-08-31T21:31:00.000Z","last_edited_time":"2023-08-31T21:31:00.000Z","created_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"last_edited_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"cover":null,"icon":{"type":"emoji","emoji":"ðŸŒ"},"parent":{"type":"page_id","page_id":"d2623db9-028f-4429-998b-fe9357923c0c"},"archived":false,"in_trash":false,"properties":{"title":{"id":"title","type":"title","title":[{"type":"text","text":{"content":"Lugares","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"Lugares","href":null}]}},"url":"https://www.notion.so/Lugares-e775fc47d30f46f79182af8c70b286f3","public_url":null},{"object":"page","id":"22f9785c-3184-4096-b0d7-82c07720b11e","created_time":"2023-08-31T21:31:00.000Z","last_edited_time":"2023-08-31T21:31:00.000Z","created_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"last_edited_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"cover":null,"icon":{"type":"emoji","emoji":"ðŸ¦¸"},"parent":{"type":"page_id","page_id":"d2623db9-028f-4429-998b-fe9357923c0c"},"archived":false,"in_trash":false,"properties":{"title":{"id":"title","type":"title","title":[{"type":"text","text":{"content":"Personagens","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"Personagens","href":null}]}},"url":"https://www.notion.so/Personagens-22f9785c31844096b0d782c07720b11e","public_url":null},{"object":"database","id":"a191e088-16a0-457e-95a0-80f440589450","cover":null,"icon":null,"created_time":"2023-08-31T21:31:00.000Z","created_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"last_edited_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"last_edited_time":"2023-08-31T21:31:00.000Z","title":[{"type":"text","text":{"content":"RaÃ§as","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"RaÃ§as","href":null}],"description":[],"is_inline":true,"properties":{"Tags":{"id":"IyXR","name":"Tags","type":"multi_select","multi_select":{"options":[]}},"Name":{"id":"title","name":"Name","type":"title","title":{}}},"parent":{"type":"page_id","page_id":"84e4e381-f4c5-4beb-b8ab-c91618c75e95"},"url":"https://www.notion.so/a191e08816a0457e95a080f440589450","public_url":null,"archived":false,"in_trash":false},{"object":"database","id":"cfcaa6ee-94a8-4b50-b3d7-bb9d2220cca4","cover":null,"icon":null,"created_time":"2023-08-31T21:31:00.000Z","created_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"last_edited_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"last_edited_time":"2023-08-31T21:31:00.000Z","title":[{"type":"text","text":{"content":"Habilidades","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"Habilidades","href":null}],"description":[],"is_inline":true,"properties":{"Tags":{"id":"IyXR","name":"Tags","type":"multi_select","multi_select":{"options":[]}},"Name":{"id":"title","name":"Name","type":"title","title":{}}},"parent":{"type":"page_id","page_id":"84e4e381-f4c5-4beb-b8ab-c91618c75e95"},"url":"https://www.notion.so/cfcaa6ee94a84b50b3d7bb9d2220cca4","public_url":null,"archived":false,"in_trash":false},{"object":"database","id":"dc1e9815-14f0-44ff-8e7b-9a7fa494516a","cover":null,"icon":null,"created_time":"2023-08-31T21:31:00.000Z","created_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"last_edited_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"last_edited_time":"2023-08-31T21:31:00.000Z","title":[{"type":"text","text":{"content":"Classes","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"Classes","href":null}],"description":[],"is_inline":true,"properties":{"Tags":{"id":"IyXR","name":"Tags","type":"multi_select","multi_select":{"options":[]}},"Name":{"id":"title","name":"Name","type":"title","title":{}}},"parent":{"type":"page_id","page_id":"84e4e381-f4c5-4beb-b8ab-c91618c75e95"},"url":"https://www.notion.so/dc1e981514f044ff8e7b9a7fa494516a","public_url":null,"archived":false,"in_trash":false},{"object":"database","id":"e364595f-124c-45f4-9a9a-0e105620a6a3","cover":null,"icon":null,"created_time":"2023-08-31T21:31:00.000Z","created_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"last_edited_by":{"object":"user","id":"6595192e-1c62-4f33-801c-84424f2ffa9c"},"last_edited_time":"2023-08-31T21:31:00.000Z","title":[{"type":"text","text":{"content":"Foco","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"Foco","href":null}],"description":[],"is_inline":true,"properties":{"Tags":{"id":"IyXR","name":"Tags","type":"multi_select","multi_select":{"options":[]}},"Name":{"id":"title","name":"Name","type":"title","title":{}}},"parent":{"type":"page_id","page_id":"84e4e381-f4c5-4beb-b8ab-c91618c75e95"},"url":"https://www.notion.so/e364595f124c45f49a9a0e105620a6a3","public_url":null,"archived":false,"in_trash":false}],"next_cursor":"f5d94fef-e0d8-4dad-aec9-8b39d6686b29","has_more":true,"type":"page_or_database","page_or_database":{},"developer_survey":"https://notionup.typeform.com/to/bllBsoI4?utm_source=postman","request_id":"c8859646-8266-4c5e-b8ca-d52654492aba"}'
    )
    successResponse.read.return_value = sample.encode("utf-8")
    conn = mocker.Mock()
    conn.getresponse.return_value = successResponse
    mocker.patch("http.client.HTTPSConnection", return_value=conn)

    # Arrange
    body: dict = {"filter": {"property": "title", "text": {"equals": "Banco de dados"}}}

    # Act
    result: dict = notion_searcher.search(body)

    # Assert
    assert result["object"] == "list", "object key not found"
    assert "results" in result, "results key not found"
    assert len(result["results"]) > 0, "results is empty"